# 1、订阅发布的主题

在下位机启动的时候向主题**one**发送**复位信息**和**设备ID**，等待上位机向**device/设备ID/sub**发送同步时间，之后如果上位机没有发送同步时间，就每隔一段时间继续发送请求同步，在此期间下位机将向**device/设备ID/post**中发布数据，如果有id卡在刷卡之后重新组装主题，将id卡号、复位信息、设备id再此发送上位机，致辞之后将发送数据到**device/设备ID/ID卡号/post**。



## 1、下位机

在没有id卡的情况下，下位机发送数据

- 订阅：device/设备ID/sub。
- 发布：device/设备ID/post

有id卡的情况

- 订阅：device/设备ID/ID卡号/sub
- 发布：device/设备ID/ID卡号/post



## 2、上位机







# 2、常用传感器的键值

|    数据名称    |         值         |  类型  |              说明              |
| :------------: | :----------------: | :----: | :----------------------------: |
|     设备ID     |     Device_ID      | string |      用的一般是2002和2001      |
|      卡号      |      ID_Cart       |  int   |                                |
|     状态位     |       state        |  int   | 0=复位同步时间，1 暂停  2 继续 |
|      回应      |        ack         |  int   | 1 ：接收完数据回传一个回应报文 |
|    同步时间    |        time        | string |       2023-9-21-18-21-20       |
|     蜂鸣器     |     beep_flag      |  int   |           0=停 、1响           |
|      温度      |    temperature     | double |                                |
|      水温      |  temperature_ds18  | double |                                |
|    温度阈值    |      TH_Temp       |  int   |                                |
|    温度报警    |      tem_flag      |  int   |      0：不报警    1：报警      |
|      湿度      |      humidity      | double |                                |
|    湿度阈值    |       TH_Hum       |  int   |                                |
|    湿度报警    |      Hum_flag      |  int   |      0：不报警    1：报警      |
|    光照强度    |      Lighting      |  int   |            百分比的            |
|    光照阈值    |      TH_light      |  int   |                                |
|    光强报警    |     light_flag     |  int   |      0：不报警    1：报警      |
|      电压      |      Voltage       | double |             0-3.3              |
|    水源浊度    |     Turbidity1     |  int   |                                |
|    饮水浊度    |     Turbidity2     |  int   |                                |
|    总饮水量    |     all_water      |  int   |                                |
|    空气质量    |        Gas         |  int   |                                |
|    空气阈值    |       TH_Gas       |  int   |                                |
|    空气报警    |      Gas_flag      |  int   |      0：不报警    1：报警      |
|  led灯的 档位  |    Led_position    |  int   |         分为0,1,2档位          |
|   电机的档位   | machinery_position |  int   |         分为 0,1,2档位         |
|    电机转速    |  machinery_speed   |  int   |           1 s 的速度           |
| 高水位、低水位 | TH_water,TL_water  |  int   |                                |
|    游玩项目    |    project_num     |  int   |                                |
|      结算      |     settlement     |  int   |             1:结算             |
|      火焰      |        fire        |  int   |                                |
|    火焰报警    |     fire_flag      |  int   |          fire_flag:1           |
|  协调器的时间  |     time_flag      |        |                                |

# 3、下位机

lcd的y坐标 0->780

x->480

## 1、串口



|  串口  |              说明              |
| :----: | :----------------------------: |
| usart1 |          打印调试信息          |
| usart2 | 给zigbee透传p03->PA3  P02->PA2 |
| usart3 |             给wifi             |
| usart6 |  给天问，PC6:PA3（t） PC7:PA2  |

## 2、定时器

| 定时器 | 引脚 | 通道  |                 说明                  |
| :----: | :--: | :---: | :-----------------------------------: |
|  TIM1  |      |       |                定时1s                 |
|  TIM2  |      |       |                                       |
| TIM10  |      |       |               定时0.1s                |
|  TIM3  | PC8  | 通道3 |              B->电机PWM               |
|  TIM3  | PB1  | 通道4 |               led的PWM                |
|  TIM4  | PE0  |       |       SIG->电机测速， TIM4->CNT       |
|  TIM5  | PH10 | 通道1 |                 舵机                  |
| TIM14  |      |       | 有os的，RT_Thread、Freertos的系统时钟 |

## 3、ADC通道

| 传感器  | 引脚 | ADC_x | 通道  |                     计算                     |
| :-----: | :--: | :---: | :---: | :------------------------------------------: |
|  光敏   | PA4  | ADC1  | 通道4 |                                              |
|  电压   | PA5  | ADC1  | 通道5 | 可调电源(float)value2 / 10 * (5.35 / 4096)*3 |
|  浊度   | PA6  | ADC1  | 通道6 |                                              |
| 空气MQ2 | PA7  | ADC1  | 通道7 |                                              |
|         |      |   -   |       |                                              |
|         |      |       |       |                      -                       |



## 4、传感器

|       传感器       |                             引脚                             |        说明         |
| :----------------: | :----------------------------------------------------------: | :-----------------: |
|       DHT11        |                             PG14                             |                     |
|        LED0        |                             PB1                              |         pwm         |
|        LED1        |                             PB0                              |    呼吸灯（1s）     |
|   rc522 rfid读卡   | PB13->SCK、PB14->MISO、PB15->MOSI、PI4 -> RC522_SDA、PI5 -> RC522_RST |        spi2         |
|       超声波       |                    TRIG->PD12、ECHO->PH6                     |                     |
|       WK_UP        |                             PA0                              |                     |
|        KEY0        |                             PH3                              |                     |
|        KEY1        |                             PH2                              |                     |
|        KEY2        |                             PC13                             |                     |
|      薄膜按键      |                    PE4 PE5 PE6（按顺序）                     |       1接 GND       |
|       蜂鸣器       |                                                              |     0 响 1 不响     |
|     人体传感器     |                             PH11                             |    1 有人 0 无人    |
| 红外传感器(input1) |                             PH12                             | 0没有触摸、1 有东西 |
|      接近开关      |                             PH14                             |  1 没有铁，0，有铁  |
|  继电器0（out0）   |                             PH7                              |                     |
|  继电器1(shuchu1)  |                             PH8                              |                     |
|  继电器2(shuchu2)  |                             PH9                              |                     |
|      ds18b20       |                             PB5                              |                     |

## 5、语音

|       词条       | 第一帧 | 第二帧 | 第三帧 |             说明             |
| :--------------: | :----: | :----: | ------ | :--------------------------: |
|     欢迎光临     |  0x01  |        |        |                              |
|   欢迎下次光临   |  0x02  |        |        |                              |
|     播报时间     |  0x03  |        |        |                              |
|   播报当前温度   |  0x04  |  整数  | 小数   |             2.2              |
|   播报当前湿度   |  0x05  |  整数  | 小数   |             2.2              |
|   温度超过阈值   |  0x06  |        |        |   警告、警告、温度超过阈值   |
|   湿度超过阈值   |  0x07  |        |        |   警告、警告、湿度超过阈值   |
| 空气质量超过阈值 |  0x08  |        |        | 警告、警告、空气质量超过阈值 |
|   水质超过阈值   |  0x09  |        |        |   警告、警告、水质超过阈值   |
|   电压超过阈值   |  0x0a  |        |        |   警告、警告、电压超过阈值   |
|     总消费为     |  0x0b  |  整数  | 小数   |                              |
|     支付成功     |  0x0c  |        |        |                              |
|     刷卡成功     |  0x0d  |        |        |                              |
|     火灾报警     |  0x0e  |        |        |                              |
|      已开启      |  0x10  |        |        |                              |
|      已关闭      |  0x11  |        |        |                              |
|    异常 异常     |  0x12  |        |        |                              |
|       正常       |  0x13  |        |        |                              |
|     警告警告     |  0x14  |        |        |                              |
|                  |        |        |        |                              |



# 4、上位机

